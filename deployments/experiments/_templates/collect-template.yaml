# Collect template - gathers metrics from Prometheus and stores in MinIO
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: collect-template
  namespace: argo-workflows
spec:
  templates:
    - name: collect-metrics
      inputs:
        parameters:
          - name: experiment-name
          - name: run-id
      outputs:
        artifacts:
          - name: metrics
            path: /tmp/results/metrics.json
            s3:
              key: "{{inputs.parameters.experiment-name}}/{{inputs.parameters.run-id}}/metrics.json"
          - name: report
            path: /tmp/results/report.md
            s3:
              key: "{{inputs.parameters.experiment-name}}/{{inputs.parameters.run-id}}/report.md"
      container:
        image: curlimages/curl:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            mkdir -p /tmp/results

            PROMETHEUS_URL="http://kube-prometheus-stack-prometheus.observability.svc:9090"
            END_TIME=$(date +%s)
            START_TIME=$((END_TIME - 300))  # Last 5 minutes

            echo "Collecting metrics from Prometheus..."
            echo "Time range: $START_TIME to $END_TIME"

            # Query request rate
            REQUEST_RATE=$(curl -s "$PROMETHEUS_URL/api/v1/query?query=rate(http_requests_total[5m])" | head -c 1000)

            # Query latency
            LATENCY=$(curl -s "$PROMETHEUS_URL/api/v1/query?query=histogram_quantile(0.95,rate(http_request_duration_seconds_bucket[5m]))" | head -c 1000)

            # Query error rate
            ERROR_RATE=$(curl -s "$PROMETHEUS_URL/api/v1/query?query=rate(http_requests_total{status=~\"5..\"}[5m])" | head -c 1000)

            # Create metrics JSON
            cat > /tmp/results/metrics.json << EOF
            {
              "experiment": "{{inputs.parameters.experiment-name}}",
              "run_id": "{{inputs.parameters.run-id}}",
              "timestamp": "$(date -Iseconds)",
              "metrics": {
                "request_rate": $REQUEST_RATE,
                "p95_latency": $LATENCY,
                "error_rate": $ERROR_RATE
              }
            }
            EOF

            # Create report
            cat > /tmp/results/report.md << EOF
            # Experiment Report: {{inputs.parameters.experiment-name}}

            ## Run Information
            - Run ID: {{inputs.parameters.run-id}}
            - Timestamp: $(date -Iseconds)

            ## Metrics Summary
            - Request Rate: See metrics.json
            - P95 Latency: See metrics.json
            - Error Rate: See metrics.json

            ## Status
            Collection completed successfully.
            EOF

            echo "Metrics collected and saved"
            cat /tmp/results/metrics.json
