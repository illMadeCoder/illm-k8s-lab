# Main experiment lifecycle WorkflowTemplate
# Orchestrates: validate -> provision -> deploy -> execute -> collect -> teardown
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: experiment-lifecycle
  namespace: argo-workflows
  labels:
    app.kubernetes.io/name: experiment-framework
spec:
  entrypoint: lifecycle
  serviceAccountName: argo-workflow

  arguments:
    parameters:
      - name: experiment-name
        description: Name of the experiment to run
      - name: environment
        description: Target environment
        default: minikube
      - name: skip-provision
        description: Skip infrastructure provisioning
        default: "true"
      - name: skip-teardown
        description: Skip teardown for debugging
        default: "false"

  templates:
    - name: lifecycle
      dag:
        tasks:
          - name: validate
            template: validate-experiment
            arguments:
              parameters:
                - name: experiment-name
                  value: "{{workflow.parameters.experiment-name}}"

          - name: deploy
            template: deploy-dependencies
            dependencies: [validate]
            arguments:
              parameters:
                - name: experiment-name
                  value: "{{workflow.parameters.experiment-name}}"

          - name: execute
            templateRef:
              name: execute-template
              template: run-load-test
            dependencies: [deploy]
            arguments:
              parameters:
                - name: experiment-name
                  value: "{{workflow.parameters.experiment-name}}"

          - name: collect
            templateRef:
              name: collect-template
              template: collect-metrics
            dependencies: [execute]
            arguments:
              parameters:
                - name: experiment-name
                  value: "{{workflow.parameters.experiment-name}}"
                - name: run-id
                  value: "{{workflow.uid}}"

    - name: validate-experiment
      inputs:
        parameters:
          - name: experiment-name
      container:
        image: bitnami/kubectl:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Validating experiment: {{inputs.parameters.experiment-name}}"

            # Check experiment directory exists
            if [ ! -d "/workspace/experiments/{{inputs.parameters.experiment-name}}" ]; then
              echo "ERROR: Experiment not found"
              exit 1
            fi

            # Check required files
            if [ ! -f "/workspace/experiments/{{inputs.parameters.experiment-name}}/experiment.yaml" ]; then
              echo "ERROR: experiment.yaml not found"
              exit 1
            fi

            echo "Validation passed"

    - name: deploy-dependencies
      inputs:
        parameters:
          - name: experiment-name
      container:
        image: bitnami/kubectl:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Checking dependencies for: {{inputs.parameters.experiment-name}}"

            # Wait for observability stack
            kubectl wait --for=condition=available deployment/kube-prometheus-stack-operator \
              -n observability --timeout=120s || true

            # Wait for Locust
            kubectl wait --for=condition=available deployment/locust-master \
              -n locust --timeout=120s || true

            # Wait for MinIO
            kubectl wait --for=condition=ready pod -l app=minio \
              -n minio --timeout=120s || true

            echo "Dependencies ready"
