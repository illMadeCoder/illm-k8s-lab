# Execute template - runs load tests via Locust
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: execute-template
  namespace: argo-workflows
spec:
  templates:
    - name: run-load-test
      inputs:
        parameters:
          - name: experiment-name
          - name: duration
            default: "60"
          - name: users
            default: "10"
          - name: spawn-rate
            default: "2"
          - name: host
            default: "http://demo-app.demo-app.svc:8080"
      steps:
        - - name: start-load
            template: start-locust
            arguments:
              parameters:
                - name: users
                  value: "{{inputs.parameters.users}}"
                - name: spawn-rate
                  value: "{{inputs.parameters.spawn-rate}}"
                - name: host
                  value: "{{inputs.parameters.host}}"

        - - name: wait-duration
            template: wait
            arguments:
              parameters:
                - name: seconds
                  value: "{{inputs.parameters.duration}}"

        - - name: stop-load
            template: stop-locust

    - name: start-locust
      inputs:
        parameters:
          - name: users
          - name: spawn-rate
          - name: host
      container:
        image: curlimages/curl:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Starting Locust load test"
            echo "Users: {{inputs.parameters.users}}"
            echo "Spawn rate: {{inputs.parameters.spawn-rate}}"
            echo "Target: {{inputs.parameters.host}}"

            # Start swarm via Locust API
            curl -s -X POST "http://locust-master.locust.svc:8089/swarm" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "user_count={{inputs.parameters.users}}&spawn_rate={{inputs.parameters.spawn-rate}}&host={{inputs.parameters.host}}"

            echo "Load test started"

    - name: stop-locust
      container:
        image: curlimages/curl:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Stopping Locust load test"
            curl -s -X GET "http://locust-master.locust.svc:8089/stop"
            echo "Load test stopped"

    - name: wait
      inputs:
        parameters:
          - name: seconds
      container:
        image: alpine:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Waiting {{inputs.parameters.seconds}} seconds..."
            sleep {{inputs.parameters.seconds}}
            echo "Wait complete"
