version: '3'

silent: true

# Cloud experiments use the LOCAL orchestrator to manage CLOUD clusters
# - Orchestrator: local kind cluster (task local:init)
# - Experiment clusters: AKS/EKS provisioned by GitLab CI + Terraform

vars:
  ORCHESTRATOR_CLUSTER: orchestrator

tasks:
  # =============================================================================
  # Experiment Lifecycle
  # =============================================================================
  conduct:
    desc: "Conduct experiment on cloud: task cloud:conduct -- <experiment-path>"
    cmds:
      - |
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "Usage: task cloud:conduct -- <experiment-path> [USERS=10] [DURATION=60s]"
          exit 1
        fi

        EXP_PATH="{{.CLI_ARGS}}"
        EXP_NAME=$(basename "$EXP_PATH")
        WORKFLOW_FILE="$EXP_PATH/workflow/experiment.yaml"

        echo "=============================================="
        echo "  CONDUCTING CLOUD EXPERIMENT: $EXP_NAME"
        echo "=============================================="
        echo ""

        # Step 1: Discover clusters from experiment folders
        echo "=== Step 1/6: Discovering clusters ==="
        CLUSTERS=""
        for cluster_dir in "$EXP_PATH"/*/; do
          if [ -f "$cluster_dir/cluster.yaml" ]; then
            cluster_name=$(basename "$cluster_dir")
            CLUSTERS="$CLUSTERS $cluster_name"
            echo "  Found: $cluster_name"
          fi
        done

        # Step 2: Trigger GitLab CI to provision clusters
        echo ""
        echo "=== Step 2/6: Provisioning cloud clusters via GitLab CI ==="
        echo "TODO: Implement GitLab CI integration"
        echo "  - Read cluster.yaml for each cluster"
        echo "  - Trigger GitLab CI pipeline for each"
        echo "  - Wait for clusters to be ready"
        echo "  - Retrieve kubeconfigs"
        exit 1

        # Step 3: Register clusters with ArgoCD on orchestrator
        echo ""
        echo "=== Step 3/6: Registering clusters with ArgoCD ==="
        echo "TODO: argocd cluster add for each cluster"

        # Step 4: Deploy apps via ArgoCD
        echo ""
        echo "=== Step 4/6: Deploying apps to clusters ==="
        echo "TODO: Apply ArgoCD apps for each cluster"

        # Step 5: Run workflow on orchestrator
        echo ""
        echo "=== Step 5/6: Running workflow ==="
        echo "TODO: Submit workflow with cloud target URLs"

        # Step 6: Cleanup - destroy cloud clusters
        echo ""
        echo "=== Step 6/6: Destroying cloud clusters ==="
        echo "TODO: Trigger GitLab CI destroy pipeline"

  deploy:
    desc: "Deploy experiment to cloud (without running): task cloud:deploy -- <experiment-path>"
    cmds:
      - |
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "Usage: task cloud:deploy -- <experiment-path>"
          exit 1
        fi

        EXP_PATH="{{.CLI_ARGS}}"
        EXP_NAME=$(basename "$EXP_PATH")

        echo "Deploying cloud experiment: $EXP_NAME"
        echo ""
        echo "TODO: Implement GitLab CI provisioning"
        echo "  1. Parse cluster.yaml files"
        echo "  2. Trigger GitLab CI pipelines"
        echo "  3. Wait for clusters"
        echo "  4. Register with ArgoCD"
        echo "  5. Deploy apps"

  destroy:
    desc: "Destroy cloud experiment clusters: task cloud:destroy -- <experiment-path>"
    cmds:
      - |
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "Usage: task cloud:destroy -- <experiment-path>"
          exit 1
        fi

        EXP_PATH="{{.CLI_ARGS}}"
        EXP_NAME=$(basename "$EXP_PATH")

        echo "Destroying cloud experiment: $EXP_NAME"
        echo ""
        echo "TODO: Implement GitLab CI destroy"
        echo "  1. Trigger GitLab CI destroy pipeline for each cluster"
        echo "  2. Remove from ArgoCD"
